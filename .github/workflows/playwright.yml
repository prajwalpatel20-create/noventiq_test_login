name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      test_tag:
        description: "Test tag to run"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - "@positive"
          - "@negative"
      browser:
        description: "Browser to run tests"
        required: true
        default: "chromium"
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      environment:
        description: "Environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - uat

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Create .env.dev file
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" > .env.dev
          echo "LOGIN_URL=${{ secrets.LOGIN_URL }}" >> .env.dev
          echo "TEST_USERNAME=${{ secrets.TEST_USERNAME }}" >> .env.dev
          echo "TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}" >> .env.dev
      - name: Create .env.uat file
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" > .env.uat
          echo "LOGIN_URL=${{ secrets.LOGIN_URL }}" >> .env.uat
          echo "TEST_USERNAME=${{ secrets.TEST_USERNAME }}" >> .env.uat
          echo "TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}" >> .env.uat
      - name: Run Playwright tests
        run: |
          TAG="${{ github.event.inputs.test_tag || 'all' }}"
          BROWSER="${{ github.event.inputs.browser || 'all' }}"
          CMD="npx playwright test"
          if [ "$TAG" != "all" ]; then
            CMD="$CMD --grep '$TAG'"
          fi
          if [ "$BROWSER" != "all" ]; then
            CMD="$CMD --project=$BROWSER"
          fi
          echo "Running: $CMD"
          eval $CMD
        env:
          TEST_ENV: ${{ github.event.inputs.environment || 'dev' }}
          BASE_URL: ${{ secrets.BASE_URL }}
          LOGIN_URL: ${{ secrets.LOGIN_URL }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      - name: Generate Allure Report
        if: always()
        run: npx allure generate allure-results --clean -o allure-report
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30
      - name: Prepare GitHub Pages
        if: always()
        run: |
          mkdir -p gh-pages
          cp -r playwright-report gh-pages/playwright
          cp -r allure-report gh-pages/allure
          echo '<html><head><title>Test Reports</title></head><body><h1>Test Reports</h1><a href="playwright/">Playwright Report</a><br><a href="allure/">Allure Report</a></body></html>' > gh-pages/index.html
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: gh-pages/

  deploy:
    needs: test
    if: always() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
