name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      test_tag:
        description: "Test tag to run"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - "@positive"
          - "@negative"
      browser:
        description: "Browser to run tests"
        required: true
        default: "chromium"
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      environment:
        description: "Environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - uat

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Create .env.dev file
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" > .env.dev
          echo "LOGIN_URL=${{ secrets.LOGIN_URL }}" >> .env.dev
          echo "TEST_USERNAME=${{ secrets.TEST_USERNAME }}" >> .env.dev
          echo "TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}" >> .env.dev
      - name: Create .env.uat file
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" > .env.uat
          echo "LOGIN_URL=${{ secrets.LOGIN_URL }}" >> .env.uat
          echo "TEST_USERNAME=${{ secrets.TEST_USERNAME }}" >> .env.uat
          echo "TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}" >> .env.uat
      - name: Run Playwright tests
        run: |
          TAG="${{ github.event.inputs.test_tag }}"
          BROWSER="${{ github.event.inputs.browser }}"
          
          # Build command based on inputs
          if [ -z "$TAG" ] || [ "$TAG" = "all" ]; then
            if [ -z "$BROWSER" ] || [ "$BROWSER" = "all" ]; then
              echo "Running: npx playwright test"
              npx playwright test
            else
              echo "Running: npx playwright test --project=$BROWSER"
              npx playwright test --project="$BROWSER"
            fi
          else
            if [ -z "$BROWSER" ] || [ "$BROWSER" = "all" ]; then
              echo "Running: npx playwright test --grep $TAG"
              npx playwright test --grep "$TAG"
            else
              echo "Running: npx playwright test --grep $TAG --project=$BROWSER"
              npx playwright test --grep "$TAG" --project="$BROWSER"
            fi
          fi
        env:
          TEST_ENV: ${{ github.event.inputs.environment || 'dev' }}
          BASE_URL: ${{ secrets.BASE_URL }}
          LOGIN_URL: ${{ secrets.LOGIN_URL }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      - name: Generate Allure Report
        if: always()
        run: npx allure generate allure-results --clean -o allure-report
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      - name: Prepare GitHub Pages
        if: always()
        run: |
          mkdir -p gh-pages
          cp -r playwright-report gh-pages/playwright
          cp -r allure-report gh-pages/allure
          echo '<html><head><title>Test Reports</title></head><body><h1>Test Reports</h1><a href="playwright/">Playwright Report</a><br><a href="allure/">Allure Report</a></body></html>' > gh-pages/index.html
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: gh-pages/
      - name: Add Job Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Reports (Click to View)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Report | View Online |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“— **Playwright Report** | [ðŸ”— View Report](https://prajwalpatel20-create.github.io/noventiq_test_login/playwright/) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“˜ **Allure Report** | [ðŸ”— View Report](https://prajwalpatel20-create.github.io/noventiq_test_login/allure/) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â„¹ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ github.event.inputs.test_tag || 'all' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Browser:** \`${{ github.event.inputs.browser || 'all' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** \`${{ github.event.inputs.environment || 'dev' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Downloaded Artifacts - How to View" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports cannot be opened directly due to browser security. Use these commands:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Playwright Report" >> $GITHUB_STEP_SUMMARY
          echo "npx playwright show-report ./playwright-report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "npx allure open ./allure-report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ **Tip:** Use the **View Online** links above for instant access!" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: test
    if: always() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
